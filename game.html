<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Number Drop Game</title>
    <style>
        body { margin: 0; padding: 10px; font-family: Arial; background: #faf8ef; touch-action: manipulation; }
        .game-container { max-width: 400px; margin: 0 auto; text-align: center; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .user-info { font-size: 14px; color: #666; }
        .back-btn { background: #999; color: white; border: none; padding: 8px 15px; border-radius: 5px; }
        
        .game-board { 
            width: 320px; height: 477px; 
            border: 2px solid #bbada0; 
            margin: 20px auto; 
            position: relative; 
            background: #cdc1b4;
            touch-action: none;
        }
        .block { 
            position: absolute; 
            width: 50px; height: 50px; 
            border-radius: 6px; 
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 18px;
            transition: all 0.3s;
        }
        .controls { margin: 20px 0; }
        button { 
            padding: 15px 25px; margin: 8px; 
            font-size: 18px; border: none; 
            border-radius: 8px; cursor: pointer;
            background: #8f7a66; color: white;
            min-height: 50px;
        }
        button:active { background: #9f8a76; transform: scale(0.95); }
        .score { font-size: 28px; font-weight: bold; color: #776e65; margin: 15px 0; }
        .touch-hint { font-size: 14px; color: #999; margin: 10px 0; }
        
        .game-over-modal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center;
        }
        .modal-content { 
            background: white; padding: 30px; border-radius: 15px; 
            text-align: center; max-width: 300px; width: 90%;
        }
        .modal-content h2 { color: #333; margin-bottom: 20px; }
        .final-score { font-size: 36px; color: #667eea; font-weight: bold; margin: 20px 0; }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="header">
            <button class="back-btn" onclick="goBack()">â† Back</button>
            <div class="user-info">
                <div id="username">Player</div>
            </div>
        </div>
        
        <div class="score">
            Score: <span id="score">0</span>
        </div>
        <div class="touch-hint">Swipe to control blocks, tap to drop</div>
        <div class="game-board" id="gameBoard"></div>
        
        <div class="controls">
            <button onclick="moveLeft()">â†</button>
            <button onclick="drop()">â†“</button>
            <button onclick="moveRight()">â†’</button>
            <br>
            <button onclick="restart()">Restart</button>
            <button onclick="pauseGame()" id="pauseBtn">Pause</button>
        </div>
    </div>
    
    <!-- æ¸¸æˆç»“æŸå¼¹çª— -->
    <div class="game-over-modal" id="gameOverModal">
        <div class="modal-content">
            <h2>ğŸ® Game Over</h2>
            <div class="final-score" id="finalScore">0</div>
            <p id="gameOverMessage">Game Over</p>
            <button class="btn" onclick="restart()" style="width: 100%; margin-bottom: 10px;">Play Again</button>
            <button class="btn" onclick="goBack()" style="width: 100%; background: #999;" id="backButton">Back to Home</button>
        </div>
    </div>

    <script>
        // ========== é”™è¯¯è°ƒè¯• ==========
        window.onerror = function(msg, url, line, col, error) {
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = 'position:fixed;top:0;left:0;width:100%;background:red;color:white;padding:10px;z-index:9999;font-size:12px;';
            errorDiv.innerHTML = `é”™è¯¯: ${msg}<br>è¡Œ: ${line}<br>åˆ—: ${col}`;
            document.body.appendChild(errorDiv);
            console.error('Game Error:', msg, url, line, col, error);
        };
        
        // ========== æ¸¸æˆæ ¸å¿ƒå˜é‡ ==========
        let score = 0;
        let currentBlock = null;
        let currentX = 3;
        let currentY = 0;
        let gameBoard = Array(10).fill().map(() => Array(6).fill(0));
        let placedBlocks = [];
        let dropInterval = null;
        let dropSpeed = 500;
        let isPaused = false;
        
        // ========== ç”¨æˆ·ä¿¡æ¯ ==========
        const API_BASE = 'http://172.20.10.5:3000';
        const userId = localStorage.getItem('userId');
        const username = localStorage.getItem('username');
        const isGuest = localStorage.getItem('isGuest') === 'true';
        
        // ========== åˆå§‹åŒ– ==========
        if (!userId || !username) {
            window.location.href = 'login.html';
        }
        
        document.getElementById('username').textContent = username;
        
        const colors = {
            2: '#eee4da', 4: '#ede0c8', 8: '#f2b179', 
            16: '#f59563', 32: '#f67c5f', 64: '#f65e3b',
            128: '#edcf72', 256: '#edcc61', 512: '#edc850',
            1024: '#edc53f', 2048: '#edc22e', 4096: '#3c3a32',
            8192: '#3c3a32', 16384: '#3c3a32', 32768: '#3c3a32'
        };
        
        function getBlockColor(number) {
            return colors[number] || '#3c3a32'; // é»‘è‰²ä½œä¸ºé»˜è®¤é¢œè‰²
        }
        
        function createBlock(number) {
            const block = document.createElement('div');
            block.className = 'block';
            block.textContent = number;
            block.style.backgroundColor = getBlockColor(number);
            block.style.color = number <= 4 ? '#776e65' : 'white';
            // å¤§æ•°å­—è°ƒæ•´å­—ä½“å¤§å°
            if (number >= 1000) {
                block.style.fontSize = '14px';
            } else if (number >= 100) {
                block.style.fontSize = '16px';
            } else {
                block.style.fontSize = '18px';
            }
            return block;
        }
        
        function spawnBlock() {
            const numbers = [2, 4, 8, 16];
            const number = numbers[Math.floor(Math.random() * numbers.length)];
            currentBlock = createBlock(number);
            currentX = 3;
            currentY = 0;
            
            if (gameBoard[0][currentX] !== 0) {
                gameOver();
                return;
            }
            
            updateBlockPosition();
            document.getElementById('gameBoard').appendChild(currentBlock);
            dropBlock();
        }
        
        function updateBlockPosition() {
            if (currentBlock) {
                currentBlock.style.left = (currentX * 53) + 'px';
                currentBlock.style.top = ((currentY - 1) * 53) + 'px';
                currentBlock.style.display = currentY === 0 ? 'none' : 'flex';
            }
        }
        
        function dropBlock() {
            currentY = 0;
            dropSpeed = 500;
            
            dropInterval = setInterval(() => {
                if (isPaused) return;
                
                currentY++;
                if (currentBlock) {
                    currentBlock.style.top = ((currentY - 1) * 53) + 'px';
                    currentBlock.style.display = currentY >= 1 ? 'flex' : 'none';
                }
                
                if (currentY >= 9 || (currentY < 9 && gameBoard[currentY + 1][currentX] !== 0)) {
                    clearInterval(dropInterval);
                    placeBlock();
                    
                    setTimeout(() => {
                        checkMerge();
                        // æœ€åå†æ¬¡åº”ç”¨é‡åŠ›ç¡®ä¿æ²¡æœ‰é—æ¼
                        applyGravity();
                        
                        if (checkGameOver()) {
                            gameOver();
                            return;
                        }
                        
                        spawnBlock();
                    }, 100);
                }
            }, dropSpeed);
        }
        
        function placeBlock() {
            if (currentBlock) {
                const number = parseInt(currentBlock.textContent);
                
                // æ£€æŸ¥å½“å‰ä½ç½®æ˜¯å¦ä¸ºç©º
                if (gameBoard[currentY][currentX] !== 0) {
                    console.error('è¯•å›¾åœ¨éç©ºä½ç½®æ”¾ç½®æ–¹å—:', currentY, currentX, 'å·²æœ‰:', gameBoard[currentY][currentX]);
                    return;
                }
                
                gameBoard[currentY][currentX] = number;
                
                placedBlocks.push({
                    element: currentBlock,
                    x: currentX,
                    y: currentY,
                    number: number
                });
                
                currentBlock = null;
            }
        }
        
        function checkMerge() {
            let merged = true;
            
            while (merged) {
                merged = false;
                
                // ä»ä¸‹åˆ°ä¸Šï¼Œä»å·¦åˆ°å³æ‰«æ
                for (let y = 9; y >= 1; y--) {
                    for (let x = 0; x < 6; x++) {
                        if (gameBoard[y][x] === 0) continue;
                        
                        const currentNumber = gameBoard[y][x];
                        
                        // åªæ£€æŸ¥ä¸‹æ–¹å’Œå³æ–¹ï¼Œé¿å…é‡å¤åˆå¹¶
                        if (y + 1 < 10 && gameBoard[y + 1][x] === currentNumber) {
                            mergeBlocks(x, y, x, y + 1);
                            merged = true;
                            break; // æ‰¾åˆ°ä¸€ä¸ªåˆå¹¶åç«‹å³é€€å‡ºï¼Œé‡æ–°æ‰«æ
                        }
                        else if (x + 1 < 6 && gameBoard[y][x + 1] === currentNumber) {
                            mergeBlocks(x, y, x + 1, y);
                            merged = true;
                            break;
                        }
                    }
                    if (merged) {
                        // æ¯æ¬¡åˆå¹¶åç«‹å³åº”ç”¨é‡åŠ›
                        applyGravity();
                        break; // é‡æ–°å¼€å§‹æ‰«æ
                    }
                }
            }
        }
        
        function mergeBlocks(x1, y1, x2, y2) {
            // ç¡®ä¿åªåˆå¹¶ç›¸åŒæ•°å­—
            if (gameBoard[y1][x1] !== gameBoard[y2][x2]) {
                console.error('Trying to merge different numbers:', gameBoard[y1][x1], gameBoard[y2][x2]);
                return;
            }
            
            const newNumber = gameBoard[y1][x1] * 2;
            gameBoard[y1][x1] = newNumber;
            gameBoard[y2][x2] = 0;
            
            updateBlockDisplay(x1, y1, newNumber);
            removeBlockDisplay(x2, y2);
            
            score += newNumber;
            const scoreEl = document.getElementById('score');
            if (scoreEl) {
                scoreEl.textContent = score;
            }
        }
        
        function applyGravity() {
            let moved = true;
            
            while (moved) {
                moved = false;
                
                for (let y = 8; y >= 1; y--) {
                    for (let x = 0; x < 6; x++) {
                        if (gameBoard[y][x] !== 0 && gameBoard[y + 1][x] === 0) {
                            gameBoard[y + 1][x] = gameBoard[y][x];
                            gameBoard[y][x] = 0;
                            
                            moveBlockDisplay(x, y, x, y + 1);
                            moved = true;
                        }
                    }
                }
            }
        }
        
        function moveBlockDisplay(fromX, fromY, toX, toY) {
            const block = findBlockAt(fromX, fromY);
            if (block) {
                block.x = toX;
                block.y = toY;
                block.element.style.left = (toX * 53) + 'px';
                block.element.style.top = ((toY - 1) * 53) + 'px';
            }
        }
        
        function checkGameOver() {
            // æ£€æŸ¥é¡¶éƒ¨å‡ è¡Œæ˜¯å¦æœ‰æ–¹å—
            for (let x = 0; x < 6; x++) {
                if (gameBoard[1][x] !== 0) {
                    return true;
                }
            }
            return false;
        }
        
        function updateBlockDisplay(x, y, number) {
            const block = findBlockAt(x, y);
            if (block) {
                block.element.textContent = number;
                block.element.style.backgroundColor = getBlockColor(number);
                block.element.style.color = number <= 4 ? '#776e65' : 'white';
                // å¤§æ•°å­—è°ƒæ•´å­—ä½“å¤§å°
                if (number >= 1000) {
                    block.element.style.fontSize = '14px';
                } else if (number >= 100) {
                    block.element.style.fontSize = '16px';
                } else {
                    block.element.style.fontSize = '18px';
                }
                block.number = number;
                block.element.style.left = (x * 53) + 'px';
                block.element.style.top = ((y - 1) * 53) + 'px';
            }
        }
        
        function removeBlockDisplay(x, y) {
            const blockIndex = placedBlocks.findIndex(b => b.x === x && b.y === y);
            if (blockIndex !== -1) {
                placedBlocks[blockIndex].element.remove();
                placedBlocks.splice(blockIndex, 1);
            }
        }
        
        function findBlockAt(x, y) {
            return placedBlocks.find(b => b.x === x && b.y === y);
        }
        
        function moveLeft() {
            if (currentBlock && currentX > 0 && !isPaused) {
                // æ£€æŸ¥å·¦ä¾§å½“å‰ä½ç½®å’Œä¸‹æ–¹ä½ç½®æ˜¯å¦æœ‰éšœç¢ç‰©
                if (currentY > 0 && gameBoard[currentY][currentX - 1] !== 0) {
                    return;
                }
                // æ£€æŸ¥ç§»åŠ¨åä¸‹ä¸€æ­¥æ˜¯å¦ä¼šç¢°æ’
                if (currentY + 1 < 10 && gameBoard[currentY + 1][currentX - 1] !== 0) {
                    return;
                }
                currentX--;
                updateBlockPosition();
            }
        }
        
        function moveRight() {
            if (currentBlock && currentX < 5 && !isPaused) {
                // æ£€æŸ¥å³ä¾§å½“å‰ä½ç½®å’Œä¸‹æ–¹ä½ç½®æ˜¯å¦æœ‰éšœç¢ç‰©
                if (currentY > 0 && gameBoard[currentY][currentX + 1] !== 0) {
                    return;
                }
                // æ£€æŸ¥ç§»åŠ¨åä¸‹ä¸€æ­¥æ˜¯å¦ä¼šç¢°æ’
                if (currentY + 1 < 10 && gameBoard[currentY + 1][currentX + 1] !== 0) {
                    return;
                }
                currentX++;
                updateBlockPosition();
            }
        }
        
        function drop() {
            if (dropInterval && currentBlock && !isPaused) {
                clearInterval(dropInterval);
                dropSpeed = 50;
                
                dropInterval = setInterval(() => {
                    currentY++;
                    if (currentBlock) {
                        currentBlock.style.top = ((currentY - 1) * 53) + 'px';
                        currentBlock.style.display = currentY >= 1 ? 'flex' : 'none';
                    }
                    
                    if (currentY >= 9 || (currentY < 9 && gameBoard[currentY + 1][currentX] !== 0)) {
                        clearInterval(dropInterval);
                        placeBlock();
                        
                        setTimeout(() => {
                            checkMerge();
                            // æœ€åå†æ¬¡åº”ç”¨é‡åŠ›ç¡®ä¿æ²¡æœ‰é—æ¼
                            applyGravity();
                            
                            if (checkGameOver()) {
                                gameOver();
                                return;
                            }
                            
                            spawnBlock();
                        }, 100);
                    }
                }, dropSpeed);
            }
        }
        
        function pauseGame() {
            isPaused = !isPaused;
            const pauseBtn = document.getElementById('pauseBtn');
            if (pauseBtn) {
                // æ ¸å¿ƒé€»è¾‘ï¼šæš‚åœ/ç»§ç»­æ¸¸æˆ
                pauseBtn.textContent = isPaused ? 'Resume' : 'Pause';
                // å›½é™…åŒ–æ›´æ–°ï¼ˆå¯é€‰ï¼Œä¸å½±å“åŠŸèƒ½ï¼‰
                try {
                    pauseBtn.textContent = isPaused ? window.Lang.t('resume') : window.Lang.t('pause');
                } catch (e) {
                    // é™é»˜å¤±è´¥ï¼Œä½¿ç”¨è‹±æ–‡é»˜è®¤å€¼
                }
            }
        }
        
        // ========== æ¸¸æˆç»“æŸå¤„ç† ==========
        async function gameOver() {
            if (dropInterval) clearInterval(dropInterval);
            
            // æ˜¾ç¤ºæ¸¸æˆç»“æŸå¼¹çª—
            document.getElementById('finalScore').textContent = score;
            
            // æ ¹æ®ç”¨æˆ·ç±»å‹å¤„ç†
            if (isGuest) {
                handleGuestGameOver();
            } else {
                await handleUserGameOver();
            }
            
            document.getElementById('gameOverModal').style.display = 'flex';
        }
        
        function handleGuestGameOver() {
            const messageEl = document.getElementById('gameOverMessage');
            const backBtn = document.getElementById('backButton');
            
            // æ ¸å¿ƒåŠŸèƒ½ï¼šæ˜¾ç¤ºæ¸¸å®¢ç»“æŸä¿¡æ¯
            if (messageEl) {
                messageEl.innerHTML = 'âš ï¸ <strong>Score not saved</strong><br>Want to save score and join global ranking?<br><a href="login.html" style="color: #667eea; text-decoration: none; font-weight: bold;">Login now</a>';
            }
            
            if (backBtn) {
                backBtn.textContent = 'Login to save score';
                backBtn.onclick = () => window.location.href = 'login.html';
            }
        }
        
        async function handleUserGameOver() {
            // æ ¸å¿ƒåŠŸèƒ½ï¼šä¿å­˜åˆ†æ•°å’Œè·å–æ’å
            await autoSaveScore();
            await updateRankingInfo();
        }
        
        async function updateRankingInfo() {
            try {
                const response = await fetch(`${API_BASE}/user/${userId}/stats`);
                const data = await response.json();
                
                const messageEl = document.getElementById('gameOverMessage');
                if (!messageEl) return;
                
                if (response.ok && data.ranking && window.i18n) {
                    const rankText = data.ranking <= 10 ? 
                        `ğŸ† ${window.i18n.t('congratulations')}ï¼${window.i18n.t('your_rank')}: ${data.ranking}` :
                        `${window.i18n.t('your_rank')}: ${data.ranking}`;
                    
                    messageEl.innerHTML = 
                        `${window.i18n.t('score_saved')}<br><span style="color: #667eea; font-weight: bold;">${rankText}</span>`;
                } else if (window.i18n) {
                    messageEl.textContent = window.i18n.t('score_saved');
                } else {
                    messageEl.textContent = 'åˆ†æ•°å·²è‡ªåŠ¨ä¿å­˜';
                }
            } catch (error) {
                console.error('è·å–æ’åä¿¡æ¯å¤±è´¥:', error);
                const messageEl = document.getElementById('gameOverMessage');
                if (messageEl) {
                    messageEl.textContent = window.i18n ? window.i18n.t('score_saved') : 'åˆ†æ•°å·²è‡ªåŠ¨ä¿å­˜';
                }
            }
        }
        
        async function autoSaveScore() {
            if (score <= 0) return;
            
            try {
                const response = await fetch(`${API_BASE}/score`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: userId,
                        score: score,
                        timestamp: Date.now()
                    })
                });
                
                if (response.ok) {
                    console.log('åˆ†æ•°è‡ªåŠ¨ä¿å­˜æˆåŠŸ');
                } else {
                    console.log('åˆ†æ•°ä¿å­˜å¤±è´¥');
                }
            } catch (error) {
                console.error('è‡ªåŠ¨ä¿å­˜å¤±è´¥:', error);
            }
        }
        
        function restart() {
            console.log('Restart called');
            score = 0;
            isPaused = false;
            document.getElementById('score').textContent = score;
            document.getElementById('gameBoard').innerHTML = '';
            document.getElementById('gameOverModal').style.display = 'none';
            
            // å®‰å…¨é‡ç½®æš‚åœæŒ‰é’®
            const pauseBtn = document.getElementById('pauseBtn');
            if (pauseBtn) {
                pauseBtn.textContent = 'æš‚åœ';
            }
            
            gameBoard = Array(10).fill().map(() => Array(6).fill(0));
            placedBlocks = [];
            if (dropInterval) clearInterval(dropInterval);
            console.log('Starting new game');
            spawnBlock();
        }
        
        function goBack() {
            if (isGuest) {
                // æ¸…ç†æ¸¸å®¢æ•°æ®
                localStorage.removeItem('isGuest');
                localStorage.removeItem('userId');
                localStorage.removeItem('username');
                localStorage.removeItem('nickname');
                window.location.href = 'login.html';
            } else {
                window.location.href = 'start.html';
            }
        }
        
        // è§¦æ‘¸æ§åˆ¶
        let touchStartX = 0;
        let touchStartY = 0;
        
        document.getElementById('gameBoard').addEventListener('touchstart', (e) => {
            e.preventDefault();
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
        });
        
        document.getElementById('gameBoard').addEventListener('touchend', (e) => {
            e.preventDefault();
            const touchEndX = e.changedTouches[0].clientX;
            const touchEndY = e.changedTouches[0].clientY;
            
            const deltaX = touchEndX - touchStartX;
            const deltaY = touchEndY - touchStartY;
            
            if (Math.abs(deltaX) > Math.abs(deltaY)) {
                if (deltaX > 30) {
                    moveRight();
                } else if (deltaX < -30) {
                    moveLeft();
                }
            } else {
                if (deltaY > 30) {
                    drop();
                } else if (Math.abs(deltaX) < 20 && Math.abs(deltaY) < 20) {
                    drop();
                }
            }
        });
        
        // é”®ç›˜æ§åˆ¶
        document.addEventListener('keydown', (e) => {
            switch(e.key) {
                case 'ArrowLeft': moveLeft(); break;
                case 'ArrowRight': moveRight(); break;
                case 'ArrowDown': drop(); break;
                case ' ': e.preventDefault(); pauseGame(); break;
            }
        });
        
        // å¯åŠ¨æ¸¸æˆ
        spawnBlock();
    </script>
</body>
</html>